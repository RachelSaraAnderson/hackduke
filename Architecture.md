# Architecture Overview

The HackDuke project includes four components: collector, API server, documentation, and sample apps.

The main technologies used are [`curl`][], [node.js][], and [MongoDB][].

## Collector

The collector is a collection of node.js scripts that retrieve/refresh the data that backs the [API Server][]

While different data sources vary in collection strategies, most scripts use a few shared functions as the basis of the collection process.

* [`db`][]: this db module contains [schemas][] and [models][] for all the various types of data that can be saved in the HackDuke database and is shared by the Collector and API Server. It also contains a mapping of collection type to fields called `queryMap` that uniquely identify a document of a particular type. This is used for avoid duplicate data. 
* [`fetch`][]: forks a child process to perform a [`curl`][] requests to endpoints and retrieves the web page content in a callback
* [`parallel`][]: slices a collection of objects containing endpoint hyperlinks into chunks and processes one chunk at a time by issuing parallel calls to [`fetch`][] for all the endpoints within a chunk using [async.js][]
* [`parsers`][]: for collectors that require parsing HTML content, predefined parsers uses [cheerio.js][] to parse and query the content and saved the necessary information as documents in the corresponding collections in [MongoDB][]

### Calendar

The calendar data are directly retrieved from the [Duke Calendar JSON Endpoints][] using [`curl`][]. The event data are left mostly unmodified except the following:

* image links are extracted to a top level field called [`image`][]
* [creator field prefix][] are removed
* [`start.date`][] and [`end.date`][] are parsed and saved as ISODates
* [`location.marker`][] links to the `ObjectId` of the Marker document that corresponds to the location link specified in the event data

### Directory

The directory data are directly retrieved from the [Duke LDAP servers][]. The results are parsed and saved as Documents in the Directory collection

### Location, Markers, Renumbering

These 3 collections of data are static and are directly saved into the corresponding collections:

* [locations][]
* [markers][]
* [course renumbers][]

### Course Data

Course data is the most hierarchical of all the data sources. The data must be collected in the correct order of precedence in order for the data to be complete. The order is outlined below:

* [departments.js][]: a-z => a list of departments
* [classes.js][]: a list of department => a list of classes
* [class.js][]: a list of classes => detailed information for each class
* [terms.js][]: a list of classes => all the terms each class is offered
* [term.js][]: a list of terms => all the sections of a class offered in each term
* [section.js][]: a list of sections => detailed information for each section
* [evaluations.js][]: a list of terms => a list of evaluations corresponding to terms
* [evaluationdetail.js][]: a list of evaluations => detailed information for each evaluation

### Post Processing

After the scraping process is complete, 2 scripts need to be run to fill the relationships between different pieces of course data.

* [parsePaths.js][]: parse paths to extract additionional data from the hyperlinks
* [relational.js][]: add cross collection refs to course data so class data can be linked properly to its terms and sections

---

## API Server

The API Server is a read-only [REST][] server that servers the data collected via various endpoints. The server is built with [restify][], with automatic caching and throttle control.

All endpoints are listed in [api.js][] and are grouped by resource type. The actual implementation of the endpoints are in the [routes][] folder. Most endpoints involve database queries with various query options and returning the result as json. Many common operations have been extracted to [util.js][].

All endpoints have a `format` querystring parameter that can hold the value of `basic`, `detailed`, and `raw`. These specify how much information is returned in increasing order. The filters to produce such formats are specified by [filters.js][].

---

## Documentation

The documentation app is based on [Swagger UI][]. The documentation JSON are generated by [apidoc.js][].

---

## Sample Apps

I've created 3 sample apps to show case different parts of the API

### Course Tree

A course catalog presented in a collapsible tree format generated using [D3.js][]

The app first loads a list of classes offered. When available, you can open up each node to reveal term and section information.

### Area Code

A visualization of the undergraduate population by state. Over 14000 phone numbers are analyzed and the area codes are turned into states. These numbers are then mapped linearly to the color and size for the states with respect to population of Dukies from that particular state. Click to zoom in and out.

### Around Me

A map based visualization to show the locations of all events occuring in the next week around campus

---

<!-- Links -->


[`curl`]: http://curl.haxx.se/docs/manpage.html
[`db`]: https://github.com/yangsu/hackduke/blob/master/db.js
[`end.date`]: https://github.com/yangsu/hackduke/blob/master/collector/calendar/calendar.js#L51
[`fetch`]: https://github.com/yangsu/hackduke/blob/master/collector/utils.js#L158-187
[`image`]: https://github.com/yangsu/hackduke/blob/master/collector/calendar/calendar.js#L45-48
[`location.marker`]: https://github.com/yangsu/hackduke/blob/master/collector/calendar/calendar.js#L63
[`parallel`]: https://github.com/yangsu/hackduke/blob/master/collector/collector.js
[`parsers`]: https://github.com/yangsu/hackduke/blob/master/collector/cheerioparser.js
[`start.date`]: https://github.com/yangsu/hackduke/blob/master/collector/calendar/calendar.js#L50
[API Server]: #api-server
[api.js]: https://github.com/yangsu/hackduke/blob/master/api.js
[apidoc.js]: https://github.com/yangsu/hackduke/blob/master/apidoc.js
[async.js]: https://github.com/caolan/async
[cheerio.js]: https://github.com/MatthewMueller/cheerio
[class.js]: https://github.com/yangsu/hackduke/blob/master/collector/class.js
[classes.js]: https://github.com/yangsu/hackduke/blob/master/collector/classes.js
[course renumbers]: https://github.com/yangsu/hackduke/blob/master/collector/renumbering/catalog_renumbering.js
[creator field prefix]: https://github.com/yangsu/hackduke/blob/master/collector/calendar/calendar.js#L49
[D3.js]: https://github.com/mbostock/d3
[departments.js]: https://github.com/yangsu/hackduke/blob/master/collector/departments.js
[Duke Calendar JSON Endpoints]: http://calendar.duke.edu/events/index.json
[Duke LDAP servers]: https://github.com/yangsu/hackduke/blob/master/collector/directory/scrapedir.sh#L8
[evaluationdetail.js]: https://github.com/yangsu/hackduke/blob/master/collector/evaluationdetail.js
[evaluations.js]: https://github.com/yangsu/hackduke/blob/master/collector/evaluations.js
[filters.js]: https://github.com/yangsu/hackduke/blob/master/routes/filters.js
[locations]: https://github.com/yangsu/hackduke/blob/master/collector/location/locations.js
[markers]: https://github.com/yangsu/hackduke/blob/master/collector/location/markers.js
[models]: http://mongoosejs.com/docs/models.html
[MongoDB]: http://www.mongodb.org/
[node.js]: http://nodejs.org
[parsePaths.js]: https://github.com/yangsu/hackduke/blob/master/collector/fixes/parsePaths.js
[relational.js]: https://github.com/yangsu/hackduke/blob/master/collector/fixes/relational.js
[REST]: http://en.wikipedia.org/wiki/Representational_state_transfer
[restify]: http://mcavage.github.io/node-restify/
[routes]: https://github.com/yangsu/hackduke/tree/master/routes
[schemas]: http://mongoosejs.com/docs/guide.html
[section.js]: https://github.com/yangsu/hackduke/blob/master/collector/section.js
[Swagger UI]: https://github.com/wordnik/swagger-ui
[term.js]: https://github.com/yangsu/hackduke/blob/master/collector/term.js
[terms.js]: https://github.com/yangsu/hackduke/blob/master/collector/terms.js
[util.js]: https://github.com/yangsu/hackduke/blob/master/routes/util.js